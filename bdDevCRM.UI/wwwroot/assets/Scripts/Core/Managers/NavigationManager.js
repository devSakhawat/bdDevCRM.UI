/*=========================================================
 * Navigation Manager (SPA Engine)
 * File: NavigationManager.js
 * Description: Handles AJAX navigation, History API, and DOM injection
 * Dependencies: AppConfig, MessageManager, ModuleRegistry, SidebarMenu, EventBus
 * Author: devSakhawat (Generated by Copilot)
 * Date: 2025-11-29
=========================================================*/

var NavigationManager = (function () {
  'use strict';

  // ============================================
  // PRIVATE - Configuration & State
  // ============================================
  var _config = {
    contentContainerId: 'spa-content-container', // ID defined in Layout
    sidebarId: 'sideNavbar',
    excludeClasses: ['no-ajax', 'dropdown-toggle'], // Links to ignore
    loadingMessage: 'Loading content...'
  };

  var _state = {
    isNavigating: false,
    currentUrl: window.location.pathname
  };

  // ============================================
  // PUBLIC - Initialization
  // ============================================

  function init() {
    
    console.log('🚀 NavigationManager initializing...');

    // 1. Bind Click Events (Event Delegation)
    _bindNavigationEvents();

    // 2. Handle Browser Back/Forward Buttons
    window.addEventListener('popstate', function (event) {
      _loadPage(window.location.pathname, false); // false = don't push state again
    });

    // 3. Initial Route Check (Load module for the landing page)
    if (typeof ModuleRegistry !== 'undefined') {
      ModuleRegistry.initByRoute(window.location.pathname);
    }

    console.log('NavigationManager initialized');
  }

  // ============================================
  // PRIVATE - Event Handlers
  // ============================================

  function _bindNavigationEvents() {
    // Listen to clicks on the Sidebar and any specific internal links
    $(document).on('click', 'a', function (e) {
      
      var $link = $(this);
      var url = $link.attr('href');
      var target = $link.attr('target');

      // Validation: Check if we should hijack this click
      if (!_shouldIntercept(url, target, $link)) {
        return;
      }

      // Prevent default browser reload
      e.preventDefault();

      // Load the page via AJAX
      _loadPage(url, true);
    });
  }

  /**
   * Determine if the link should be handled by SPA
   */
  function _shouldIntercept(url, target, $link) {
    // Ignore invalid URLs
    if (!url || url === '#' || url.indexOf('javascript:') === 0) return false;

    // Ignore external links
    if (url.indexOf('http') === 0 && url.indexOf(window.location.origin) === -1) return false;

    // Ignore new tab requests
    if (target === '_blank') return false;

    // Ignore specific exclusions
    if ($link.hasClass('no-ajax') || $link.hasClass('dropdown-toggle')) return false;

    // Ignore download links
    if (url.match(/\.(pdf|doc|docx|xls|xlsx|zip|rar)$/i)) return false;

    return true;
  }

  // ============================================
  // PRIVATE - Core Logic
  // ============================================

  /**
   * Fetch and Render Page
   * @param {string} url - The URL to fetch
   * @param {boolean} pushState - Whether to update browser history
   */
  async function _loadPage(url, pushState) {
    if (_state.isNavigating && url === _state.currentUrl) return;

    _state.isNavigating = true;
    _state.currentUrl = url;

    console.log('🔄 SPA Navigation to:', url);

    //// 1. Notify App (Start)
    //if (typeof EventBus !== 'undefined') {
    //  EventBus.emit('navigation:start', { url: url });
    //}

    //// 2. Show Loading
    //if (typeof MessageManager !== 'undefined') {
    //  MessageManager.loading.show(_config.loadingMessage);
    //}

    try {
      console.log('🔄 Navigating to:', url);

      //// Show loading
      //if (typeof MessageManager !== 'undefined') {
      //  MessageManager.loading.show('Loading...');
      //}

      ////Step 1: Re-render sidebar menu from cache
      //await _ensureSidebarMenu();

      // Step 2: Fetch new content
      var response = await fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (!response.ok) {
        throw new Error('Failed to load page:  ' + response.status);
      }

      const htmlContent = await response.text();
      // Step 3: Extract and inject content
      var $content = $('#' + _config.contentContainerId);
      if ($content.length > 0) {
        // Parse response and extract content
        var $parsed = $('<div>').html(htmlContent);
        var newContent = $parsed.find('#' + _config.contentContainerId).html();

        if (newContent) {
          $content.html(newContent);
        } else {
          $content.html(htmlContent);
        }
      }

      // Step 4: Update browser history
      if (pushState) {
        history.pushState({ url: url }, '', url);
      }

      //////Step 1: Re-render sidebar menu from cache
      //await _ensureSidebarMenu();

      //_state.currentUrl = url;
      //document.title = "bdDevs CRM";

      // Step 5: Initialize route-specific modules
      if (typeof ModuleRegistry !== 'undefined') {
        await ModuleRegistry.initByRoute(url);
      }

      ////Step 1: Re-render sidebar menu from cache
      await _ensureSidebarMenu();

      _state.currentUrl = url;
      document.title = "bdDevs CRM";

      ////Step 6: Highlight active menu item
      //_highlightActiveMenuItem(url);

      console.log('SPA Navigation complete');

      //// 4. Inject Content
      //var $container = $('#' + _config.contentContainerId);
      //$container.fadeOut(100, function () {
      //  $container.html(htmlContent).fadeIn(200);

      //  // 5. Update URL & State
      //  if (pushState) {
      //    history.pushState({ url: url }, '', url);
      //  }
      //  _state.currentUrl = url;
      //  document.title = "bdDevs CRM"; // Optionally parse title from response

      //  // 6. Post-Load Initialization
      //  _afterContentLoad(url);
      //});

    } catch (error) {
      console.error('SPA Navigation failed:', error);
      // Fallback:  Full page reload
      window.location.href = url;
    } finally {
      _state.isNavigating = false;
      ////if (typeof MessageManager !== 'undefined') {
      ////  MessageManager.loading.hide();
      ////}

      //_state.isNavigating = false;
      //if (typeof MessageManager !== 'undefined') {
      //  MessageManager.loading.hide();
      //}

      //// Notify App (End)
      //if (typeof EventBus !== 'undefined') {
      //  EventBus.emit('navigation:end', { url: url });
      //}
    }
  }

  //NEW: Ensure sidebar menu is rendered
  async function _ensureSidebarMenu() {
    var $sidebar = $('#' + _config.sidebarId);

    // Check if sidebar is empty or has only skeleton
    var hasMenuItems = $sidebar.find('.nav-item[data-menu-id]').length > 0;

    if (!hasMenuItems) {
      console.log('Sidebar empty, loading from cache.. .');

      // Try cache first
      if (typeof StorageManager !== 'undefined') {
        var cachedMenu = StorageManager.getCachedMenu();

        if (cachedMenu && cachedMenu.length > 0) {
          console.log('Rendering menu from cache:', cachedMenu.length, 'items');

          if (typeof SidebarMenu !== 'undefined' && SidebarMenu.renderFromCache) {
            SidebarMenu.renderFromCache(cachedMenu);
            return;
          }
        }
      }

      // No cache - fetch from API
      console.log('No cache, fetching menu from API...');
      if (typeof SidebarMenu !== 'undefined' && SidebarMenu.GetMenuInformation) {
        await SidebarMenu.GetMenuInformation();
      }
    }
  }

  //NEW: Highlight active menu item
  function _highlightActiveMenuItem(url) {
    var $sidebar = $('#' + _config.sidebarId);

    // Remove all active classes
    $sidebar.find('.nav-link').removeClass('active');
    $sidebar.find('.nav-item').removeClass('active');

    // Find and highlight current menu item
    var pathname = new URL(url, window.location.origin).pathname;

    $sidebar.find('.nav-link').each(function () {
      var href = $(this).attr('href');
      if (href && href.includes(pathname)) {
        $(this).addClass('active');
        $(this).closest('.nav-item').addClass('active');

        // Expand parent submenu if exists
        $(this).closest('.submenu').addClass('show');
        $(this).closest('.has-submenu').find('> .nav-link').removeClass('collapsed');
      }
    });
  }

  /**
   * Re-initialize UI components after AJAX load
   */
  function _afterContentLoad(url) {
    // A. Update Active Menu (Using your existing SidebarMenu)
    if (typeof SidebarMenu !== 'undefined') {
      SidebarMenu.setActiveMenuByUrl(url);
    }

    // B. Initialize Module Logic (Using your existing ModuleRegistry)
    if (typeof ModuleRegistry !== 'undefined') {
      ModuleRegistry.initByRoute(url);
    }

    // C. Re-initialize Feather Icons
    if (typeof feather !== 'undefined') {
      feather.replace();
    }

    // D. Re-initialize Tooltips
    if (typeof tippy !== 'undefined') {
      tippy('[data-tippy-content]');
    }

    // E. Scroll to top
    window.scrollTo(0, 0);
  }

  // ============================================
  // PUBLIC API
  // ============================================
  return {
    init: init,
    loadPage: function (url) { _loadPage(url, true); } // Public method to force navigation
  };
})();